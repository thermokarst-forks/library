import sys

from library.packages.models import Package


# README:
# This script is intended to be run inside the dokku/docker instance running
# the library's web worker:
# python manage.py shell
#
# This script takes two positional arguments:
# argv[1]: a filepath with txt of package names, generated by packages.py
# argv[2]: a filepath to write a csv of tokens to


def read_packages(packages_fp):
    with open(packages_fp) as fh:
        return [p.strip() for p in fh.readlines()]


def write_tokens(tokens_fp, packages):
    with open(tokens_fp, 'w') as fh:
        for name in packages:
            package, _ = Package.objects.get_or_create(
                name=name,
                core=True,
                repository='qiime2/%s' % (name,)
            )
            line = '%s,%s' % (package.name, package.token)
            print(line)
            fh.write('%s\n' % (line,))


if __name__ == '__main__':
    packages_fp = sys.argv[1]
    packages = read_packages(packages_fp)

    tokens_fp = sys.argv[2]
    write_tokens(tokens_fp, packages)
